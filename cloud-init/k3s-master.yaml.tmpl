#cloud-config
users:
  - name: clement
    gecos: Clément Cassé
    groups: users,admin,wheel
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /usr/bin/bash
    ssh_import_id:
      - gh:clement-casse

disk_setup:
  /dev/vda:
    table_type: "mbr"
    layout: true

fs_setup:
  - device: /dev/vda1
    filesystem: "ext4"

package_update: true
package_upgrade: true
packages:
  - curl
  - ca-certificates
  - unattended-upgrades

write_files:
  - path: /etc/rancher/k3s/config.yaml
    content: |
      bind-address: 0.0.0.0
      https-listen-port: 6443
      write-kubeconfig-mode: "0640"
      tls-san:
        - "{{ .K3S.Server.Name }}"
        - "{{ .K3S.Server.Name }}.{{ .Tailscale.TailnetName }}.ts.net"
      cluster-cidr: "{{ .K3S.ClusterPodCIDR }}"
      service-cidr: "10.43.0.0/16"
      service-node-port-range: "30000-32767"
      cluster-init: true
      flannel-backend: "none"
      disable-network-policy: true
      disable-helm-controller: true
      disable:
        - "traefik"
        - "metrics-server"
  - path: /etc/sysctl.d/90-cilium.conf
    owner: root:root
    content: |
      fs.inotify.max_user_watches = 524288
      fs.inotify.max_user_instances = 512
  - path: /etc/sysctl.d/99-tailscale.conf
    owner: root:root
    content: |
      net.ipv4.ip_forward = 1
      net.ipv6.conf.all.forwarding = 1

runcmd:
  - [sh, -c, "curl -fsSL https://tailscale.com/install.sh | sh"]
  - [sysctl, -p, "/etc/sysctl.d/90-cilium.conf"]
  - [sysctl, -p, "/etc/sysctl.d/99-tailscale.conf"]
  - [
      "tailscale",
      "up",
      "--authkey={{ .Tailscale.ServerOAuthKey.Secret }}",
      "--advertise-tags=tag:server",
    ]
  - [tailscale, set, --ssh, "--hostname={{ .K3S.Server.Name }}"]
  - [
      sh,
      -c,
      "curl -sfL https://get.k3s.io | K3S_CONFIG_FILE='/etc/rancher/k3s/config.yaml' sh -",
    ]
  - [
      sh,
      -c,
      {{- $ciliumVersion := "$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)" -}}
      {{- $ciliumArch := "arm64" }}
      "curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/{{$ciliumVersion}}/cilium-linux-{{$ciliumArch}}.tar.gz{,.sha256sum}; sha256sum --check cilium-linux-{{$ciliumArch}}.tar.gz.sha256sum; tar xzvfC cilium-linux-{{$ciliumArch}}.tar.gz /usr/local/bin; rm cilium-linux-{{$ciliumArch}}.tar.gz; rm cilium-linux-{{$ciliumArch}}.tar.gz.sha256sum;"
    ]
  - [
      sh,
      -c,
      "KUBECONFIG=/etc/rancher/k3s/k3s.yaml cilium install --version 1.16.0 --namespace kube-system --set=ipam.operator.clusterPoolIPv4PodCIDRList={{ .K3S.ClusterPodCIDR }}"
    ]
  - [
      sh,
      -c,
      "KUBECONFIG=/etc/rancher/k3s/k3s.yaml cilium status --wait"
    ]